#
# Makefile for tflite/vino/mvi : Tensor Flow Lite / Intel OpneVINO / IBM MVI OpenCV Object Classification
#

# Check all necessary environment variables
-include ../../env.check.mk

export CR_DST=us.icr.io
export CR_NAMESPACE_DST=ieam-mvi

export ARCH ?= $(shell hzn architecture)

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

all: max-mvi-fm mvi-fm max-mvi-hv mvi-hv

max-mvi-fm: max-mvi-fm-publish-service

mvi-fm: mvi-fm-build mvi-fm-push mvi-fm-publish-service mvi-fm-deploy-policy

max-mvi-hv: max-mvi-hv-publish-service

mvi-hv: mvi-hv-build mvi-hv-push mvi-hv-publish-service mvi-hv-deploy-policy

# Build the docker container
tflite-build:
	 envsubst < ./Dockerfile.tflite.$(ARCH) | docker build -t $(DOCKER_IMAGE_BASE_TFLITE)_$(ARCH):$(SERVICE_VERSION_TFLITE) . -f -

vino-build:
	 envsubst < ./Dockerfile.vino.$(ARCH) | docker build -t $(DOCKER_IMAGE_BASE_VINO)_$(ARCH):$(SERVICE_VERSION_VINO) . -f -

mvi-fm-build:
	 envsubst < ./Dockerfile.mvi.$(ARCH) | docker build -t $(DOCKER_IMAGE_BASE_MVI_FM)_$(ARCH):$(SERVICE_VERSION_MVI_FM) . -f -

mvi-hv-build:
	 envsubst < ./Dockerfile.mvi.$(ARCH) | docker build -t $(DOCKER_IMAGE_BASE_MVI_HV)_$(ARCH):$(SERVICE_VERSION_MVI_HV) . -f -

# Push the docker container to the DockerHub registry
tflite-push:
	docker push $(DOCKER_IMAGE_BASE_TFLITE)_$(ARCH):$(SERVICE_VERSION_TFLITE)

vino-push:
	docker push $(DOCKER_IMAGE_BASE_VINO)_$(ARCH):$(SERVICE_VERSION_VINO)

mvi-fm-push:
	docker push $(DOCKER_IMAGE_BASE_MVI_FM)_$(ARCH):$(SERVICE_VERSION_MVI_FM)

mvi-hv-push:
	docker push $(DOCKER_IMAGE_BASE_MVI_HV)_$(ARCH):$(SERVICE_VERSION_MVI_HV)

# Publish a Horizon service (per service.json) and pull image to get its sha256
tflite-publish-service:
	hzn exchange service publish -f horizon/$(IMAGE_NAME_TFLITE).service.definition.json --pull-image

vino-publish-service:
	hzn exchange service publish -f horizon/$(IMAGE_NAME_VINO).service.definition.json --pull-image

max-mvi-fm-publish-service:
	docker login -u iamapikey -p $(APP_CR_API_KEY_RO_PULL) $(CR_DST)
	hzn exchange service publish -f horizon/$(IMAGE_NAME_MAX_MVI_FM).service.definition.json --pull-image -r "$(CR_DST):iamapikey:$(APP_CR_API_KEY_RO_PULL)" 

max-mvi-hv-publish-service:
	docker login -u iamapikey -p $(APP_CR_API_KEY_RO_PULL) $(CR_DST)
	hzn exchange service publish -f horizon/$(IMAGE_NAME_MAX_MVI_HV).service.definition.json --pull-image -r "$(CR_DST):iamapikey:$(APP_CR_API_KEY_RO_PULL)" 

mvi-fm-publish-service:
	hzn exchange service publish -f horizon/$(IMAGE_NAME_MVI_FM).service.definition.json --pull-image

mvi-hv-publish-service:
	hzn exchange service publish -f horizon/$(IMAGE_NAME_MVI_HV).service.definition.json --pull-image

# Deployment policy
tflite-deploy-policy:
	hzn exchange deployment addpolicy -f horizon/$(IMAGE_NAME_TFLITE).deploy.policy.json deploy-$(EDGE_OWNER).$(EDGE_DEPLOY).$(IMAGE_NAME_TFLITE)_$(ARCH)

vino-deploy-policy:
	hzn exchange deployment addpolicy -f horizon/$(IMAGE_NAME_VINO).deploy.policy.json deploy-$(EDGE_OWNER).$(EDGE_DEPLOY).$(IMAGE_NAME_VINO)_$(ARCH)

mvi-fm-deploy-policy:
	hzn exchange deployment addpolicy -f horizon/$(IMAGE_NAME_MVI_FM).deploy.policy.json deploy-$(EDGE_OWNER).$(EDGE_DEPLOY).$(IMAGE_NAME_MVI_FM)_$(ARCH)

mvi-hv-deploy-policy:
	hzn exchange deployment addpolicy -f horizon/$(IMAGE_NAME_MVI_HV).deploy.policy.json deploy-$(EDGE_OWNER).$(EDGE_DEPLOY).$(IMAGE_NAME_MVI_HV)_$(ARCH)

#mvi-max deploys as requiredService in mvi deployment
#mvi-hv-max deploys as requiredService in mvi deployment

#-------------------------------
test-docker-run-tflite:
	docker run -it --device=/dev/video0:/dev/video0 --env-file ENV_FILE $(DOCKER_IMAGE_BASE_TFLITE)_$(ARCH):$(SERVICE_VERSION_TFLITE) /bin/bash

test-docker-run-vino:
	docker run -it --device=/dev/video0:/dev/video0 --env-file ENV_FILE --privileged -v /dev:/dev --network=host --mount type=bind,source=/tmp,target=/test $(DOCKER_IMAGE_BASE_VINO)_$(ARCH):$(SERVICE_VERSION_VINO) /bin/bash 

test-docker-run-mvi:
	docker run -it --device=/dev/video0:/dev/video0 --env-file ENV_FILE --privileged -v /tmp:/tmp $(DOCKER_IMAGE_BASE_MVI)_$(ARCH):$(SERVICE_VERSION_MVI) /bin/bash

# Remove the local container image
clean:
	rm -f .hzn.json.tmp.mk

# This imports the variables from hzn.json
.hzn.json.tmp.mk: horizon/hzn.json
	@ hzn util configconv -f $< > $@

