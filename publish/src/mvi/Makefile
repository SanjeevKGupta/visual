#
# Makefile for mvi : MVI Container Object Classification
#

# Check all necessary environment variables
-include ../../env.check.mk

export CR_DST=us.icr.io
export CR_NAMESPACE_DST=ieam-mvi

export ARCH ?= $(shell hzn architecture)

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

# Publish a Horizon service (per service.json) and pull image to get its sha256
mvi-publish-service:
	docker login -u iamapikey -p $(APP_CR_API_KEY_RO_PULL) $(CR_DST)
	hzn exchange service publish -r "$(CR_DST):iamapikey:$(APP_CR_API_KEY_RO_PULL)" -f horizon/$(IMAGE_NAME).service.definition.json --pull-image

mvi-deploy-policy:
	hzn exchange deployment addpolicy -f horizon/$(IMAGE_NAME).deploy.policy.json deploy-$(EDGE_OWNER).$(EDGE_DEPLOY).$(IMAGE_NAME)_$(ARCH)

#-------------------------------
# Remove the local container image
clean:
	rm -f .hzn.json.tmp.mk

# This imports the variables from hzn.json
.hzn.json.tmp.mk: horizon/hzn.json
	@ hzn util configconv -f $< > $@

